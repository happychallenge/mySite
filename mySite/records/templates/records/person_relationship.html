{% extends "base.html" %}
{% load i18n static %}

{% block header-index %}
    <h2>기억을 통해 실수를 반복하지 맙시다.</h2>
    <a href="{% url 'records:check_person' %}"> 
            <button type='button' class='btn btn-primary pull-right'>사람/시건/뉴스 등록</button>
    </a>
    <ol class="breadcrumb">
        <li>
            <a href="{% url 'home' %}"> <i class="fa fa-home"></i> Home </a> 
        </li>
        <li>
            <a>인물</a>
        </li>
        <li class="active">
            <strong>가족 관계</strong>
        </li>
    </ol>
{% endblock header-index %}


{% block content %}

    <div class="wrapper wrapper-content">
        <div class="row animated fadeInRight">
    
            {# 001. 증조부 #}
            <div class="col-md-12">
                {% for parent in person.get_parent %}
                    {% for parent in parent.get_parent %}
                        {% if parent.get_parent %}
                            {% include 'records/partial/person_info_for_relationship.html' with relationship='증부모' persons=parent.get_parent %}
                        {% endif %}  
                    {% endfor %}
                {% endfor %}
            </div>

            {# 002. 조부모 #}
            <div class="col-md-12">
                {% for parent in person.get_parent %}
                    {% if parent.get_parent %}
                        {% include 'records/partial/person_info_for_relationship.html' with relationship='조부모' persons=parent.get_parent %}
                    {% endif %}  
                {% endfor %}
            </div>

            {# 003. 부모 #}
            <div class="col-md-12">
                {% if person.get_parent %}
                    {% include 'records/partial/person_info_for_relationship.html' with relationship='부모' persons=person.get_parent %}
                {% endif %}  
            </div>

            {# 004. 본인/아내/남 #}
            <div class="col-md-12">
                {% include 'records/partial/person_info_for_menspouse.html' with relationship='본인 & 아내 또는 남편' person=person %}
            </div>

            {# 005. 자식들 #}
            <div class="col-md-12">
                {% if person.get_children %}
                    {% include 'records/partial/person_info_for_relationship.html' with relationship='자식들' persons=person.get_children %}
                {% endif %}  
            </div>

        </div> {# class="row animated fadeInRight" #}
    </div>

    <!-- MODAL TO FAMILY RELATIONSHIP -->
    <div class="modal fade" id="modal-relation">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="{% url 'records:register_relation' person.id %}" method="POST"> 
                <!-- HEADER -->    
                    <div class="modal-header">
                        <button class="close" type='button' data-dismiss='modal' aria-label='Close'>
                            <span aria-hidden='true'>&times;</span>
                        </button>
                        <h4 class="modal-title"> 가족 관계 등록 </h4>
                    </div>

                    <!-- BODY -->
                    <div class="modal-body">
                    
                        {% csrf_token %}
                        <!-- PARENT -->
                        <div class="row">
                            <div class='center'>
                                <p>가족 관계를 등록하기 위해서는 반드시 해당 인력이 먼저 등록이 되어야 합니다.</p>
                                <p class="text-success"> 부모님의 이름을 입력하시기 바랍니다. </p></div>
                        </div>
                        <div class="row"> <!-- 부모님 -->
                            <div class="col-xs-3 search">
                                <input type="text" class="form-control" id="id_parent">
                                <div class="results" id="parent_results">
                                  
                                </div>
                            </div>
                            <div class="center col-xs-4 i-checks" style="padding:10px 0px;">
                                <label><input name="ptype" type="radio" value="아버지" class="iradio_square-green" checked> <i></i> 아버지 </label>
                                <label><input name="ptype" type="radio" value="어머니" class="iradio_square-green"> <i></i> 어머니 </label>
                            </div>
                            <div class="col-xs-4 made-input">
                                <div class="col-xs-4" id="parent_name">
                                    
                                </div>
                                <div class="col-xs-2" id="parent_id">
                                    
                                </div>
                            </div>
                        </div>
                    
                        <!-- SPOUSE -->
                        <div class="row">
                            <div class='center'>
                                <p class="text-success"> 아내/남편 이름을 입력하시기 바랍니다. </p>
                            </div>
                        </div>
                        <div class="row"> <!-- 부모님 -->
                            <div class="col-xs-3 search">
                                <input type="text" class="form-control" id="id_spouse">
                                <div class="results" id="spouse_results">
                                  
                                </div>
                            </div>
                            <div class="center col-xs-4 i-checks" style="padding:10px 0px;">
                                <label><input name="stype" type="radio" value="아버지" class="iradio_square-green" checked> <i></i> 아내 </label>
                                <label><input name="stype" type="radio" value="어머니" class="iradio_square-green"> <i></i> 남편 </label>
                            </div>
                            <div class="col-xs-4 made-input">
                                <div class="col-xs-4" id="spouse_name">
                                    
                                </div>
                                <div class="col-xs-2" id="spouse_id">
                                    
                                </div>
                            </div>
                        </div>

                        <!-- CHILD -->
                        <div class="row">
                            <div class='center'>
                                <p class="text-success"> 자식의 이름을 입력하시기 바랍니다. 자식을 여러명을 반복해서 입력할 수 있습니다. </p>
                            </div>
                        </div>
                        <div class="row"> <!-- 부모님 -->
                            <div class="col-xs-3 search">
                                <input type="text" class="form-control" id="id_children">
                                <div class="results" id="children_results">
                                  
                                </div>
                            </div>
                            <div class="center col-xs-4 i-checks" style="padding:10px 0px;">
                                <label><input name="ctype" type="radio" value="아들" class="iradio_square-green" checked> <i></i> 아들 </label>
                                <label><input name="ctype" type="radio" value="딸" class="iradio_square-green"> <i></i> 딸 </label>
                            </div>
                            <div class="col-xs-4 made-input">
                                <div class="col-xs-4" id="children_name">
                                    
                                </div>
                                <div class="col-xs-2" id="children_id">
                                    
                                </div>
                            </div>
                        </div>
                        <div style="display:block;width:100%;height:100px;"></div>
                    
                    </div>

                    <!-- FOOTER -->
                    <div class="modal-footer">
                        <button type='button' class="btn btn-default" data-dismiss='modal'>Cancel</button>
                        <button type='submit' class="btn btn-primary btn-relationship" >Create Relationship</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock content %}


{% block right_side %}
    {% include 'right_side.html' with type='P' %}
{% endblock right_side %}


{% block javascript %}
{# <link rel="stylesheet" href="{% static 'css/persons.css' %}">  #}
<link href="{% static 'css/plugins/iCheck/custom.css' %}" rel="stylesheet">
<link href="{% static 'css/persons.css' %}" rel="stylesheet">

<script>
$(function(){

    // PARENT
    $("#id_parent").keyup(function(){
        var search = $(this).val();

        $.ajax({
            url: "{% url 'records:search_persons' %}", 
            data: {
                'keyword': search,
            },
            dataType: 'json',
            success: function(data){
                $("#parent_results").show();
                $("#parent_results").html(data);
            }
        });
        return false;
    });
    
    $("#parent_results").on('click', 'div.child', function(){
        var parent_id = this.id.split(':')[0];
        var parent_name = this.id.split(':')[1];

        $("#id_parent").val(parent_name);
        $('<input>').attr({
            type: 'text',
            id: 'id_parent_name',
            value: parent_name
        }).appendTo('#parent_name');

        $('<input>').attr({
            type: 'hidden',
            id: 'id_parent_id',
            name: 'parent_id',
            value: parent_id
        }).appendTo('#parent_id');

        $("#parent_results").hide();
    });

    // SPOUSE
    $("#id_spouse").keyup(function(){
        var search = $(this).val();

        $.ajax({
            url: "{% url 'records:search_persons' %}", 
            data: {
                'keyword': search,
            },
            dataType: 'json',
            success: function(data){
                $("#spouse_results").show();
                $("#spouse_results").html(data);
            }
        });
        return false;
    });
    
    $("#spouse_results").on('click', 'div.child', function(){
        var spouse_id = this.id.split(':')[0];
        var spouse_name = this.id.split(':')[1];

        $("#id_spouse").val(spouse_name);
        $('<input>').attr({
            type: 'text',
            id: 'id_spouse_name',
            value: spouse_name
        }).appendTo('#spouse_name');

        $('<input>').attr({
            type: 'hidden',
            id: 'id_spouse_id',
            name: 'spouse_id',
            value: spouse_id
        }).appendTo('#spouse_id');

        $("#spouse_results").hide();
    });

    // CHILDREN
    $("#id_children").keyup(function(){
        var search = $(this).val();

        $.ajax({
            url: "{% url 'records:search_persons' %}", 
            data: {
                'keyword': search,
            },
            dataType: 'json',
            success: function(data){
                $("#children_results").show();
                $("#children_results").html(data);
            }
        });
        return false;
    });
    
    $("#children_results").on('click', 'div.child', function(){
        var children_id = this.id.split(':')[0];
        var children_name = this.id.split(':')[1];

        $("#id_children").val("");
        $('<input>').attr({
            type: 'text',
            id: 'id_children_name',
            value: children_name
        }).appendTo('#children_name');

        $('<input>').attr({
            type: 'checkbox',
            id: 'id_children_id',
            name: 'children_id',
            value: children_id,
            checked: 'checked'
        }).appendTo('#children_id');

        $("#children_results").hide();
    });

    // Modal Window 뜨위기
    $(".createRelation").click(function(){
        $("#modal-relation").modal("show");
    });

});
</script>
{% endblock javascript %}
